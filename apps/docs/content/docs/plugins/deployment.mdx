---
title: Deployment
description: Build and deploy plugins to production
---

## Build Configuration

The template includes Module Federation configuration for building deployable plugins:

```javascript title="rspack.config.cjs"
const { ModuleFederationPlugin } = require("@module-federation/enhanced/rspack");

module.exports = {
  mode: process.env.NODE_ENV || "development",
  entry: "./src/index.ts",
  plugins: [
    new ModuleFederationPlugin({
      name: "my-plugin",
      filename: "remoteEntry.js",
      exposes: {
        "./plugin": "./src/index.ts",
      },
      shared: {
        "every-plugin": { singleton: true },
        "effect": { singleton: true },
        "zod": { singleton: true },
        "@orpc/server": { singleton: true }, // For source plugins
      },
    }),
  ],
  resolve: {
    extensions: [".ts", ".js"],
  },
  module: {
    rules: [
      {
        test: /\.ts$/,
        use: "ts-loader",
        exclude: /node_modules/,
      },
    ],
  },
};
```

## Build Process

### Development Build

```bash
# Start development server
npm run dev
# Plugin available at http://localhost:3001/remoteEntry.js
```

### Production Build

```bash
# Build for production
npm run build
# Creates dist/remoteEntry.js and supporting files
```

The build output includes:
- `remoteEntry.js` - Main plugin entry point
- Supporting chunk files for dependencies
- Source maps (in development)

## Deployment Options

### CDN Deployment

Deploy to a CDN for global availability:

```bash
# Example with AWS S3 + CloudFront
aws s3 sync dist/ s3://my-plugins-bucket/my-plugin@1.0.0/
aws cloudfront create-invalidation --distribution-id E123456789 --paths "/*"
```

### Container Registry

Package plugins in containers for enterprise deployment:

```dockerfile title="Dockerfile"
FROM nginx:alpine

# Copy built plugin files
COPY dist/ /usr/share/nginx/html/

# Configure CORS for Module Federation
COPY nginx.conf /etc/nginx/nginx.conf

EXPOSE 80
```

```nginx title="nginx.conf"
events {
    worker_connections 1024;
}

http {
    include       /etc/nginx/mime.types;
    default_type  application/octet-stream;

    server {
        listen 80;
        
        # Enable CORS for Module Federation
        add_header Access-Control-Allow-Origin *;
        add_header Access-Control-Allow-Methods "GET, POST, OPTIONS";
        add_header Access-Control-Allow-Headers "Content-Type";

        location / {
            root /usr/share/nginx/html;
            try_files $uri $uri/ =404;
        }
    }
}
```

### Private Registry

Host plugins in a private registry:

```bash
# Build and tag
docker build -t my-registry.com/plugins/my-plugin:1.0.0 .
docker push my-registry.com/plugins/my-plugin:1.0.0

# Deploy with Kubernetes
kubectl apply -f plugin-deployment.yaml
```

## Registry Configuration

Update your plugin registry with the deployed URL:

```typescript title="registry.ts"
export const registry = {
  "my-plugin": {
    remoteUrl: "https://cdn.example.com/plugins/my-plugin@1.0.0/remoteEntry.js",
    type: "transformer",
    version: "1.0.0",
    description: "My custom data processing plugin",
    metadata: {
      author: "My Organization",
      license: "MIT",
      repository: "https://github.com/my-org/my-plugin",
    },
  },
};
```

## Versioning Strategy

### Semantic Versioning

Follow semantic versioning for plugin releases:

```json title="package.json"
{
  "name": "@my-org/my-plugin",
  "version": "1.2.3",
  "description": "My plugin"
}
```

- **Major** (1.x.x): Breaking changes to plugin interface
- **Minor** (x.2.x): New features, backward compatible
- **Patch** (x.x.3): Bug fixes, backward compatible

### Deployment Paths

Structure deployment paths by version:

```
https://cdn.example.com/plugins/
├── my-plugin@1.0.0/
│   ├── remoteEntry.js
│   └── ...
├── my-plugin@1.1.0/
│   ├── remoteEntry.js
│   └── ...
└── my-plugin@latest/  # Symlink to latest stable
    ├── remoteEntry.js
    └── ...
```

## Testing Deployment

### Integration Testing

Test deployed plugins before updating registry:

```typescript title="test-deployment.ts"
import { createPluginRuntime, PluginRuntime } from "every-plugin/runtime";

const testDeployment = async () => {
  const runtime = createPluginRuntime({
    registry: {
      "my-plugin": {
        remoteUrl: "https://cdn.example.com/plugins/my-plugin@1.0.0/remoteEntry.js",
        type: "transformer",
        version: "1.0.0",
      },
    },
    secrets: {
      API_KEY: process.env.TEST_API_KEY,
    },
  });

  try {
    const result = await runtime.runPromise(
      Effect.gen(function* () {
        const pluginRuntime = yield* PluginRuntime;
        
        const plugin = yield* pluginRuntime.usePlugin("my-plugin", {
          secrets: { apiKey: "{{API_KEY}}" },
        });
        
        return yield* pluginRuntime.executePlugin(plugin, {
          items: ["test-item"],
        });
      })
    );

    console.log("Deployment test successful:", result);
  } catch (error) {
    console.error("Deployment test failed:", error);
    process.exit(1);
  } finally {
    await runtime.dispose();
  }
};

testDeployment();
```

### Health Checks

Implement health check endpoints:

```typescript title="health-check.ts"
// Add to your plugin for monitoring
export const healthCheck = async (pluginUrl: string): Promise<boolean> => {
  try {
    const response = await fetch(pluginUrl, { method: "HEAD" });
    return response.ok;
  } catch {
    return false;
  }
};
```

## CI/CD Pipeline

### GitHub Actions Example

```yaml title=".github/workflows/deploy.yml"
name: Deploy Plugin

on:
  push:
    tags:
      - 'v*'

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
      - uses: actions/checkout@v3
      
      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '18'
          
      - name: Install dependencies
        run: npm ci
        
      - name: Run tests
        run: npm test
        
      - name: Build plugin
        run: npm run build
        
      - name: Deploy to CDN
        run: |
          aws s3 sync dist/ s3://my-plugins-bucket/my-plugin@${{ github.ref_name }}/
          aws cloudfront create-invalidation --distribution-id ${{ secrets.CLOUDFRONT_ID }} --paths "/*"
        env:
          AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
          AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          
      - name: Update registry
        run: |
          # Update plugin registry with new version
          curl -X POST "${{ secrets.REGISTRY_WEBHOOK_URL }}" \
            -H "Content-Type: application/json" \
            -d '{
              "plugin": "my-plugin",
              "version": "${{ github.ref_name }}",
              "url": "https://cdn.example.com/plugins/my-plugin@${{ github.ref_name }}/remoteEntry.js"
            }'
```

## Security Considerations

### Content Security Policy

Configure CSP headers for plugin loading:

```typescript
// Runtime configuration
const runtime = createPluginRuntime({
  registry,
  secrets,
  security: {
    allowedOrigins: [
      "https://cdn.example.com",
      "https://trusted-plugins.com",
    ],
    requireHttps: true,
  },
});
```

### Plugin Signing

Sign plugins for integrity verification:

```bash
# Sign plugin with private key
openssl dgst -sha256 -sign private-key.pem -out remoteEntry.js.sig remoteEntry.js

# Verify signature in runtime
openssl dgst -sha256 -verify public-key.pem -signature remoteEntry.js.sig remoteEntry.js
```

## Monitoring

### Plugin Metrics

Track plugin performance and usage:

```typescript
// Add to plugin for telemetry
export const metrics = {
  executionTime: 0,
  errorCount: 0,
  successCount: 0,
};

// In execute method
const startTime = Date.now();
try {
  const result = await this.processData(input);
  metrics.successCount++;
  return result;
} catch (error) {
  metrics.errorCount++;
  throw error;
} finally {
  metrics.executionTime = Date.now() - startTime;
}
```

## Next Steps

<Cards>
  <Card title="Examples" href="/docs/examples">
    See deployed plugins in real-world scenarios
  </Card>
  <Card title="Runtime Integration" href="/docs/runtime">
    Learn how to use deployed plugins
  </Card>
  <Card title="Core Concepts" href="/docs/core">
    Understand the plugin system architecture
  </Card>
</Cards>
