---
title: Multi-Source Pipeline
description: Combine multiple data sources and process through plugin workflows
---

This example demonstrates reading from multiple source streams and processing data through a plugin pipeline.

## Architecture

<Mermaid
  chart="
graph LR
  A[Social Stream] --> C[Merge]
  B[News Stream] --> C
  C --> D[Content Processor]
  D --> E[Sentiment Analyzer]
  E --> F[Output]"
/>

## Setup

Configure the runtime with multiple source plugins and processors:

```typescript
import { Effect, Stream } from "effect";
import { createPluginRuntime, PluginRuntime } from "every-plugin/runtime";

const runtime = createPluginRuntime({
  registry: {
    "social-feed": {
      remoteUrl: "https://cdn.example.com/plugins/social/remoteEntry.js",
      type: "source",
      version: "1.0.0"
    },
    "news-api": {
      remoteUrl: "https://cdn.example.com/plugins/news/remoteEntry.js", 
      type: "source",
      version: "1.0.0"
    },
    "content-processor": {
      remoteUrl: "https://cdn.example.com/plugins/processor/remoteEntry.js",
      type: "transformer",
      version: "1.0.0"
    },
    "sentiment-analyzer": {
      remoteUrl: "https://cdn.example.com/plugins/sentiment/remoteEntry.js",
      type: "transformer", 
      version: "1.0.0"
    }
  },
  secrets: {
    SOCIAL_API_KEY: "social-secret",
    NEWS_API_KEY: "news-secret"
  }
});
```

## Multi-Source Streaming

Create streams from multiple sources and merge them:

```typescript
const processMultiSourcePipeline = await runtime.runPromise(
  Effect.gen(function* () {
    const pluginRuntime = yield* PluginRuntime;

    // Initialize processor plugins
    const contentProcessor = yield* pluginRuntime.usePlugin("content-processor", {
      variables: { maxLength: 500 }
    });

    const sentimentAnalyzer = yield* pluginRuntime.usePlugin("sentiment-analyzer", {
      variables: { threshold: 0.7 }
    });

    // Create source streams
    const socialStream = yield* pluginRuntime.streamPlugin(
      "social-feed",
      {
        secrets: { apiKey: "{{SOCIAL_API_KEY}}" },
        variables: { timeout: 30000 }
      },
      {
        procedure: "search",
        input: { query: "typescript", limit: 20 },
        state: null
      },
      { maxItems: 100 }
    );

    const newsStream = yield* pluginRuntime.streamPlugin(
      "news-api", 
      {
        secrets: { apiKey: "{{NEWS_API_KEY}}" },
        variables: { timeout: 30000 }
      },
      {
        procedure: "search",
        input: { query: "typescript", limit: 20 },
        state: null
      },
      { maxItems: 100 }
    );

    // Merge streams and process through pipeline
    const processedResults = yield* Stream.merge(socialStream, newsStream).pipe(
      // Process content
      Stream.mapEffect((item) =>
        pluginRuntime.executePlugin(contentProcessor, {
          items: [item]
        }).pipe(
          Effect.catchAll((error) => {
            console.warn("Content processing failed:", error);
            return Effect.succeed({ items: [] });
          })
        )
      ),
      Stream.flatMap((result) => Stream.fromIterable(result.items)),
      
      // Analyze sentiment
      Stream.mapEffect((item) =>
        pluginRuntime.executePlugin(sentimentAnalyzer, {
          items: [item]
        }).pipe(
          Effect.catchAll((error) => {
            console.warn("Sentiment analysis failed:", error);
            return Effect.succeed({ items: [] });
          })
        )
      ),
      Stream.flatMap((result) => Stream.fromIterable(result.items)),
      
      // Collect results
      Stream.take(50),
      Stream.runCollect
    );

    return Array.from(processedResults);
  }).pipe(
    Effect.catchAll((error) => {
      console.error("Pipeline failed:", error);
      return Effect.succeed([]);
    })
  )
);
```

## Batch Processing

Process items in batches for better performance:

```typescript
const batchProcessPipeline = await runtime.runPromise(
  Effect.gen(function* () {
    const pluginRuntime = yield* PluginRuntime;

    const batchProcessor = yield* pluginRuntime.usePlugin("content-processor", {
      variables: { batchSize: 10 }
    });

    const socialStream = yield* pluginRuntime.streamPlugin(
      "social-feed",
      config,
      input
    );

    const batchedResults = yield* socialStream.pipe(
      Stream.grouped(10), // Process in batches of 10
      Stream.mapEffect((batch) =>
        pluginRuntime.executePlugin(batchProcessor, {
          items: Array.from(batch)
        })
      ),
      Stream.flatMap((result) => Stream.fromIterable(result.items)),
      Stream.runCollect
    );

    return Array.from(batchedResults);
  })
);
```

## Error Recovery

Handle failures gracefully with retry logic:

```typescript
const resilientPipeline = await runtime.runPromise(
  Effect.gen(function* () {
    const pluginRuntime = yield* PluginRuntime;

    const processor = yield* pluginRuntime.usePlugin("content-processor", config);

    const socialStream = yield* pluginRuntime.streamPlugin(
      "social-feed",
      config,
      input
    );

    const processedResults = yield* socialStream.pipe(
      Stream.mapEffect((item) =>
        pluginRuntime.executePlugin(processor, { items: [item] }).pipe(
          Effect.retry({ times: 3 }),
          Effect.catchAll((error) => {
            console.warn(`Failed to process item after retries:`, error);
            return Effect.succeed({ items: [] });
          })
        )
      ),
      Stream.flatMap((result) => Stream.fromIterable(result.items)),
      Stream.filter((item) => item !== null),
      Stream.runCollect
    );

    return Array.from(processedResults);
  })
);
```

## Resource Management

Ensure proper cleanup in production:

```typescript
// Graceful shutdown
process.on("SIGTERM", async () => {
  console.log("Shutting down pipeline...");
  await runtime.disposeRuntime();
  process.exit(0);
});

// Error handling
process.on("unhandledRejection", async (error) => {
  console.error("Unhandled rejection:", error);
  await runtime.disposeRuntime();
  process.exit(1);
});
```

## Next Steps

<Cards>
  <Card title="Data Aggregation" href="/docs/examples/data-aggregation">
    Combine and deduplicate data from multiple sources
  </Card>
  <Card title="Real-time Processing" href="/docs/examples/real-time-processing">
    Continuous processing with state management
  </Card>
  <Card title="Streaming Guide" href="/docs/runtime/streaming">
    Learn more about streaming patterns
  </Card>
</Cards>
